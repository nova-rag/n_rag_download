<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/2025/assets/css/just-the-docs-default.css"> <script src="/2025/assets/js/vendor/lunr.min.js"></script> <script src="/2025/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Binary Exploitation and RISC-V Warmup | 6.5950/6.5951</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Binary Exploitation and RISC-V Warmup" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Secure Hardware Design" /> <meta property="og:description" content="Secure Hardware Design" /> <meta property="og:site_name" content="6.5950/6.5951" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Binary Exploitation and RISC-V Warmup" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Secure Hardware Design","headline":"Binary Exploitation and RISC-V Warmup","url":"/2025/recitations/riscv.html"}</script> <!-- End Jekyll SEO tag --> <!-- Cover up the page while CSS is loading to prevent flicker --> <div id="preload-cover"></div> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" /> <style> #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#fff; z-index:9999; } @media (prefers-color-scheme: dark) { #preload-cover { position:fixed; height:100%; width:100%; top:0; left:0; background:#222326; z-index:9999; } } </style> <script> window.addEventListener('load', function() { var cover = document.getElementById('preload-cover'); cover.style.display = 'none'; }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Feather. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/2025/" class="site-title lh-tight"> 6.5950/6.5951 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/2025/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/2025/calendar.html" class="nav-list-link">Calendar</a></li><li class="nav-list-item"><a href="/2025/lectureReadings.html" class="nav-list-link">Lecture Readings</a></li><li class="nav-list-item"><a href="/2025/paperDiscussion.html" class="nav-list-link">Paper Discussion</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Recitations category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2025/recitations.html" class="nav-list-link">Recitations</a><ul class="nav-list "><li class="nav-list-item "><a href="/2025/recitations/cpp.html" class="nav-list-link">CTF of C Programming</a></li><li class="nav-list-item "><a href="/2025/recitations/cache.html" class="nav-list-link">Cache Recitation</a></li><li class="nav-list-item "><a href="/2025/recitations/physical.html" class="nav-list-link">CTF of Physical Attacks</a></li><li class="nav-list-item active"><a href="/2025/recitations/riscv.html" class="nav-list-link active">Binary Exploitation and RISC-V Warmup</a></li><li class="nav-list-item "><a href="/2025/recitations/formal.html" class="nav-list-link">Formal Verification</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/2025/labs.html" class="nav-list-link">Labs</a><ul class="nav-list "><li class="nav-list-item "><a href="/2025/labs/ccc.html" class="nav-list-link">C Crash Course</a></li><li class="nav-list-item "><a href="/2025/labs/fingerprinting.html" class="nav-list-link">Website Fingerprinting</a></li><li class="nav-list-item "><a href="/2025/labs/cache.html" class="nav-list-link">Cache Attacks</a></li><li class="nav-list-item "><a href="/2025/labs/spectre.html" class="nav-list-link">Spectre Attacks</a></li><li class="nav-list-item "><a href="/2025/labs/rowhammer.html" class="nav-list-link">Rowhammer</a></li><li class="nav-list-item "><a href="/2025/labs/aslr.html" class="nav-list-link">ASLR Bypasses</a></li><li class="nav-list-item "><a href="/2025/labs/psp.html" class="nav-list-link">Pretty Secure Processor</a></li><li class="nav-list-item "><a href="/2025/labs/fuzz.html" class="nav-list-link">CPU Fuzzing</a></li><li class="nav-list-item "><a href="/2025/labs/formal.html" class="nav-list-link">CPU Verification</a></li></ul></li><li class="nav-list-item"><a href="/2025/paperReadingGuidance.html" class="nav-list-link">Paper Readings Guidance</a></li><li class="nav-list-item"><a href="/2025/forInstructors.html" class="nav-list-link">For Instructors</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search 6.5950/6.5951" aria-label="Search 6.5950/6.5951" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <span id="dark-light-switch" class="material-symbols-outlined"></span> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/2025/recitations.html">Recitations</a></li> <li class="breadcrumb-nav-list-item"><span>Binary Exploitation and RISC-V Warmup</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="binary-exploitation-and-risc-v-warmup"> <a href="#binary-exploitation-and-risc-v-warmup" class="anchor-heading" aria-labelledby="binary-exploitation-and-risc-v-warmup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Binary Exploitation and RISC-V Warmup </h1> <h2 class="no_toc" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h2> <ul id="markdown-toc"> <li><a href="#instruction-reference-table" id="markdown-toc-instruction-reference-table">Instruction Reference Table</a></li> <li><a href="#calling-convention" id="markdown-toc-calling-convention">Calling Convention</a></li> <li><a href="#gdb-debugging" id="markdown-toc-gdb-debugging">GDB Debugging</a></li> <li><a href="#binary-exploitation-and-ctf-tools" id="markdown-toc-binary-exploitation-and-ctf-tools">Binary Exploitation and CTF Tools</a></li> <li><a href="#privileged-extensions" id="markdown-toc-privileged-extensions">Privileged Extensions</a></li> <li><a href="#hands-on-puzzles" id="markdown-toc-hands-on-puzzles">Hands-on Puzzles</a></li> </ul> <p>In case your RISC-V assembly is a bit rusty, here’s a quick guide to the <code class="language-plaintext highlighter-rouge">rv32i</code> ISA, standing for RISC-V 32-bit Base Integer Instruction Set. We will also go through a few recitation exercises to get you familiar with binary exploitation that will come in handy in the fuzzing lab.</p> <p>In RISC-V, there are 32 general-purpose registers (<code class="language-plaintext highlighter-rouge">x0</code> to <code class="language-plaintext highlighter-rouge">x31</code>) and a program counter (<code class="language-plaintext highlighter-rouge">pc</code>). All the registers have the bit-length of 32. <code class="language-plaintext highlighter-rouge">x0</code> is hardcoded to always be zero when read, and the remaining registers (<code class="language-plaintext highlighter-rouge">x1-x31</code>) are free for programmer use. The program counter <code class="language-plaintext highlighter-rouge">pc</code> points to the current instruction being executed. Each instruction is 32-bits long (4 bytes) and is always byte aligned. For things not covered in this recitation, you should refer to</p> <ul> <li><strong><a href="../labs/psp.html#documentation-where-do-i-learn-more">The list official RISCV document</a></strong></li> </ul> <!-- <img src="figures/riscv-1.png" width="35%" style="margin-left:auto;margin-right:auto;"/> *Figure 2.1 from the RISC-V ISA Volume I: RISC-V base unprivileged integer register state.* --> <h2 id="instruction-reference-table"> <a href="#instruction-reference-table" class="anchor-heading" aria-labelledby="instruction-reference-table"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Instruction Reference Table </h2> <p>In the assembly code, you could write instructions that are directly implemented by the hardware. You could also write pseudo instructions, which are just convenient syntactic sugar and the assembler could translate them into instructions directly implemented by the hardware. Here is a reference of these instructions and their assembly code format:</p> <ul> <li><strong>RISC-V assembly format of <a href="https://github.com/metheis/riscv/blob/master/index.md#rv32i-base-integer-instruction-set">instructions directly implemented by the hardware</a> and <a href="https://github.com/metheis/riscv/blob/master/asm.md#assembler-pseudo-instructions">pseudo instructions</a></strong></li> </ul> <h2 id="calling-convention"> <a href="#calling-convention" class="anchor-heading" aria-labelledby="calling-convention"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Calling Convention </h2> <p>The RISC-V ISA defines a calling convention (application binary interface, or <em>ABI</em>), assigning meanings to the general purpose registers. The following is a breakdown of all of the registers and their meanings. Note how each register (<code class="language-plaintext highlighter-rouge">x1-x31</code>) has a corresponding <em>ABI</em> name. In assembly, you can refer to the register using either. For example, <code class="language-plaintext highlighter-rouge">x2</code> means exactly the same register as <code class="language-plaintext highlighter-rouge">sp</code> (one is simply more readable than the other). The reference file is:</p> <ul> <li><strong><a href="https://riscv.org/wp-content/uploads/2015/01/riscv-calling.pdf">RISC-V Calling Convention</a></strong></li> </ul> <p><img src="figures/riscv-2.png" width="50%" style="margin-left:auto;margin-right:auto;" /></p> <p><em>Table 18.2 from the RISC-V Calling Convention: RISC-V calling convention register usage.</em></p> <h3 class="no_toc" id="caller-saved-vs-callee-saved-registers"> <a href="#caller-saved-vs-callee-saved-registers" class="anchor-heading" aria-labelledby="caller-saved-vs-callee-saved-registers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Caller-saved vs. Callee-saved Registers </h3> <p>Since functions tend to modify registers as part of their execution, the ABI splits the registers into two kinds: <em>callee-save</em> or <em>caller-save</em>. Registers that are defined to be callee-saved need to be saved and restored by the callee (the function being called). That is, functions need to save and restore these registers. On the other hand, registers defined to be caller-saved are allowed to be changed freely by a function being called (you don’t need to save and restore these). However, a function that calls other functions should not assume these registers hold their value across method calls.</p> <p>In RISC-V, all arguments are passed via registers (and the stack if there aren’t enough registers). Refer to the calling convention document for the specifics, but at a high level, arguments are passed via <code class="language-plaintext highlighter-rouge">a0</code>, <code class="language-plaintext highlighter-rouge">a1</code>, <code class="language-plaintext highlighter-rouge">a2</code>, and so on. When a function is complete, the return value is passed via <code class="language-plaintext highlighter-rouge">a0</code> (and <code class="language-plaintext highlighter-rouge">a1</code> if needed).</p> <h3 class="no_toc" id="function-call-linkage"> <a href="#function-call-linkage" class="anchor-heading" aria-labelledby="function-call-linkage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Function Call Linkage </h3> <p>The RISC-V instruction to call a method is <code class="language-plaintext highlighter-rouge">jal</code> (Jump and Link). <code class="language-plaintext highlighter-rouge">jal</code> allows the program to jump to a function (setting <code class="language-plaintext highlighter-rouge">pc</code> to the function to execute), and records the next instruction after <code class="language-plaintext highlighter-rouge">jal</code> (<code class="language-plaintext highlighter-rouge">pc+4</code>) into the return address register <code class="language-plaintext highlighter-rouge">ra</code>.</p> <p>When a function is ready to exit, it executes the <code class="language-plaintext highlighter-rouge">ret</code> instruction. This is not a “real” instruction, rather, <code class="language-plaintext highlighter-rouge">ret</code> is a shorthand way of writing <code class="language-plaintext highlighter-rouge">jalr x0, ra</code> to jump to the return address (effectively undoing the original <code class="language-plaintext highlighter-rouge">jalr</code> that brought us into the function!)</p> <h3 class="no_toc" id="stack-management"> <a href="#stack-management" class="anchor-heading" aria-labelledby="stack-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Stack Management </h3> <p>The function must save and restore any registers it uses to the stack. In the beginning, a function will make some space on the stack (by subtracting from <code class="language-plaintext highlighter-rouge">sp</code>, the stack pointer), and save any necessary registers in the new space. At the end, the function will teardown its stack frame by restoring any saved registers, and resetting <code class="language-plaintext highlighter-rouge">sp</code> to its original value before executing <code class="language-plaintext highlighter-rouge">ret</code>.</p> <p>A function can also use the stack for storing local variables.</p> <blockquote class="exercise-title"> <p>Level 1</p> <p>Let’s start with solving <a href="#hands-on-puzzles">our Hands-on Puzzle</a> level 1 to get familiar with commonly used RISCV instructions and the calling convention.</p> </blockquote> <h2 id="gdb-debugging"> <a href="#gdb-debugging" class="anchor-heading" aria-labelledby="gdb-debugging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> GDB Debugging </h2> <p>If you are experiencing crashes and don’t know why when working with C or assembly code, you can use GDB to help figure out where your exploit is going wrong.</p> <p>We will go through an example of running GDB on the starter code of level 1.3 (after level 1.1 and 1.2 are done) on <code class="language-plaintext highlighter-rouge">unicorn</code>.</p> <p>Set <code class="language-plaintext highlighter-rouge">DEBUG_PORT</code> in <code class="language-plaintext highlighter-rouge">config.sh</code> using the debug port we emailed you for lab6.A.</p> <p>Run the level 1.3 code with <code class="language-plaintext highlighter-rouge">--debug</code> enabled:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./run.sh level1 --debug
Waiting for debugger on port XXXX...
</code></pre></div></div> <p>Open another terminal and run gdb with:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./gdb.sh level1
...
Reading symbols from build/level1...
Remote debugging using localhost:XXXX
0x00001000 in ?? ()
(gdb)
</code></pre></div></div> <p>It will pause the execution right before the program starts. Now, for debugging, you probably want to pause the execution at a specific point in the program, which is called “breakpoint”. To do so, you first create a breakpoint, at the label of <code class="language-plaintext highlighter-rouge">problem_3</code> for example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) b problem_3
Breakpoint 1 at 0x80000540: file src/level1_asm.s, line 115.
</code></pre></div></div> <p>Then “coninute” run the program and it will automatically pause right before the breakpoint you just set:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) c
Continuing.

Breakpoint 1, problem_3 () at src/level1_asm.s:116
116     mv a0, zero # &lt;- Replace this with your code
=&gt; 0x80000548 &lt;problem_3+0&gt;: 00000513.   li  a0,0
</code></pre></div></div> <p>The output means the next instruction to execute is at line 116 of level1_asm.s, which is assembly code <code class="language-plaintext highlighter-rouge">mv a0, zero</code>. In the binary, this line of code is compiled to a <code class="language-plaintext highlighter-rouge">li a0, 0</code> instruction. We can then execute instruction one-by-one with “next” command:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) n
119     call problem3_target
=&gt; 0x8000054c &lt;problem_3+4&gt;: 1d4000ef    jal 0x80000720 &lt;problem3_target&gt;
</code></pre></div></div> <p>When the next instruction is a function call, “next” command will directly execute all instructions in the function until the function returns (You could try that!). However, we sometime might want to look into the body of function, which can be achieved with “step”:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) s
problem3_target (str=0x0) at src/level1.c:86
86      puts("Checking Problem 3\r\n");
=&gt; 0x80000734 &lt;problem3_target+20&gt;: 800017b7    lui a5,0x80001
   0x80000738 &lt;problem3_target+24&gt;: 0dc78513    add a0,a5,220 # 0x800010dc
   0x8000073c &lt;problem3_target+28&gt;: 965ff0ef    jal 0x800000a0 &lt;puts&gt;
</code></pre></div></div> <p>Note that, sometime, it stops only at the next line of <strong>C code</strong> in the function (instead of the next instruction in the binary), which is already the pc at <code class="language-plaintext highlighter-rouge">&lt;problem3_target+20&gt;</code>. To see what are the instruction between <code class="language-plaintext highlighter-rouge">&lt;problem3_target+0&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;problem3_target+20&gt;</code> that have been executed, use command <code class="language-plaintext highlighter-rouge">x/8i problem3_target</code>, where <code class="language-plaintext highlighter-rouge">x</code> means “examine memory”, <code class="language-plaintext highlighter-rouge">8</code> means “printing following 8 entries”, <code class="language-plaintext highlighter-rouge">i</code> means “format it as instructions”, and <code class="language-plaintext highlighter-rouge">problem3_target</code> is the address to print:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/8i problem3_target
   0x80000720 &lt;problem3_target&gt;:    add sp,sp,-32
   0x80000724 &lt;problem3_target+4&gt;:  sw  ra,28(sp)
   0x80000728 &lt;problem3_target+8&gt;:  sw  s0,24(sp)
   0x8000072c &lt;problem3_target+12&gt;: add s0,sp,32
   0x80000730 &lt;problem3_target+16&gt;: sw  a0,-20(s0)
=&gt; 0x80000734 &lt;problem3_target+20&gt;: lui a5,0x80001
   0x80000738 &lt;problem3_target+24&gt;: add a0,a5,220
   0x8000073c &lt;problem3_target+28&gt;: jal 0x800000a0 &lt;puts&gt;
</code></pre></div></div> <p>Now, to debug your solution of level 1.3, you might be curious what is the state (e.g., regfile, stack) of the processor and check whether you have filled the values correctly. You can do check regfile with “info registers”:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) info registers
ra             0x80000550   0x80000550 &lt;problem_3+8&gt;
sp             0x80101fd0   0x80101fd0
...
a0             0x0  0
a1             0x0  0
...
pc             0x80000734   0x80000734 &lt;problem3_target+20&gt;
</code></pre></div></div> <p>You can see the stack pointer <code class="language-plaintext highlighter-rouge">sp</code> is <code class="language-plaintext highlighter-rouge">0x80101fd0</code>. Then, you can print the value stored in this location with <code class="language-plaintext highlighter-rouge">x/16w 0x80101fd0</code>, where <code class="language-plaintext highlighter-rouge">w</code> means “format as a word”:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/16w 0x80101fd0
0x80101fd0: 0x00000000  0xf1e57fcd  0xdeadc0de  0x00000000
0x80101fe0: 0x00000000  0x00000000  0x80102000  0x80000550
0x80101ff0: 0x80102000  0x80000010  0x00000000  0x00000000
0x80102000: 0x00000000  0x00000000  0x00000000  0x00000000
</code></pre></div></div> <p>Alternatively, <code class="language-plaintext highlighter-rouge">x/8 $sp</code> could print the same thing, saving you a Ctrl-c/Ctrl-v:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/16w $sp
0x80101fd0: 0x00000000  0xf1e57fcd  0xdeadc0de  0x00000000
0x80101fe0: 0x00000000  0x00000000  0x80102000  0x80000550
0x80101ff0: 0x80102000  0x80000010  0x00000000  0x00000000
0x80102000: 0x00000000  0x00000000  0x00000000  0x00000000
</code></pre></div></div> <p>Now, you could start to modify the code for level 1.3 and check how the stack value is changed by your code. You can quit gdb with <code class="language-plaintext highlighter-rouge">q</code>.</p> <p>Below summarize the commands we have used in gdb.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Commands</th> <th>Explanation</th> </tr> </thead> <tbody> <tr> <td><strong>b label</strong></td> <td>Set a breakpoint at the label.</td> </tr> <tr> <td><strong>c</strong></td> <td>Continue until the next instruction is a breakpoint.</td> </tr> <tr> <td><strong>n</strong></td> <td>Step over a single instruction (skip function calls).</td> </tr> <tr> <td><strong>s</strong></td> <td>Step over a single instruction.</td> </tr> <tr> <td><strong>info registers</strong></td> <td>Examine register values.</td> </tr> <tr> <td><strong>x/8i addr</strong></td> <td>Examine memory starting from addr for 8 instruction entries.</td> </tr> <tr> <td><strong>x/16w addr</strong></td> <td>Examine memory starting from addr for 16 data word entries.</td> </tr> <tr> <td><strong>q</strong></td> <td>Quit gdb.</td> </tr> </tbody> </table></div> <p>You can learn more about GDB <a href="https://www.sourceware.org/gdb/documentation/">here</a> or by googling some functions you expect from GDB.</p> <h2 id="binary-exploitation-and-ctf-tools"> <a href="#binary-exploitation-and-ctf-tools" class="anchor-heading" aria-labelledby="binary-exploitation-and-ctf-tools"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Binary Exploitation and CTF Tools </h2> <blockquote class="exercise-title"> <p>Level 2-5</p> <p>Level 2-5 guides you to build off from a buffer overflow to a return-to-win attack and then a ROP attack. These exercises will be useful in the fuzzing lab. When you get confused about what the assembly code is doing, refer to the GDB debugging section above. GDB is also needed for getting the stack pointer in level 5.</p> </blockquote> <h2 id="privileged-extensions"> <a href="#privileged-extensions" class="anchor-heading" aria-labelledby="privileged-extensions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Privileged Extensions </h2> <p>We now provide additional materials for getting warm up for the fuzzing lab. Take a look at the <a href="https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf">RISC-V ISA Volume II</a>. This manual provides an overview of the privilege modes available to RISC-V systems and how to transition between them. As you will recall from earlier labs, the OS kernel runs in a higher privilege level than user programs – this volume describes that mechanism on RISC-V. In the fuzzing lab, you will be writing programs that run with higher privilege levels, and will write code to handle privilege transitions (AKA exceptions).</p> <h3 class="no_toc" id="privilege-levels"> <a href="#privilege-levels" class="anchor-heading" aria-labelledby="privilege-levels"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Privilege Levels </h3> <p>There are 4 privilege levels in the RISC-V ISA, of which two of them we will use in our labs.</p> <p><img src="figures/riscv-4.png" width="40%" style="margin-left:auto;margin-right:auto;" /></p> <p><em>Table 1.1 from the RISC-V ISA Volume II: RISC-V privilege levels.</em></p> <p>For the sake of this class, we will use the convention that level 0 (<em>U</em> mode) is userspace, and level 3 (<em>M</em> mode) is kernelspace. In the fuzzing lab, these privilege modes will be referred to as <code class="language-plaintext highlighter-rouge">PSP_PRIV_USER</code> and <code class="language-plaintext highlighter-rouge">PSP_PRIV_MACHINE</code>, respectively.</p> <p>Levels 1 and 2 are not used in this class.</p> <h3 class="no_toc" id="control-and-status-registers-csrs"> <a href="#control-and-status-registers-csrs" class="anchor-heading" aria-labelledby="control-and-status-registers-csrs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Control and Status Registers (CSRs) </h3> <p>Control and Status Registers (CSRs for short) are special privileged CPU registers that configure how the CPU behaves. They can be read/ written with the <code class="language-plaintext highlighter-rouge">csrr</code>, <code class="language-plaintext highlighter-rouge">csrw</code>, and <code class="language-plaintext highlighter-rouge">csrrw</code> instructions while operating in M mode.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Instruction</th> <th>Example</th> <th>Usage</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">csrr</code>- CSR Read</td> <td><code class="language-plaintext highlighter-rouge">csrr x1, SOME_CSR</code></td> <td>Read <code class="language-plaintext highlighter-rouge">SOME_CSR</code> into register <code class="language-plaintext highlighter-rouge">x1</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">csrw</code>- CSR Write</td> <td><code class="language-plaintext highlighter-rouge">csrw SOME_CSR, x1</code></td> <td>Write <code class="language-plaintext highlighter-rouge">x1</code> into <code class="language-plaintext highlighter-rouge">SOME_CSR</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">csrrw</code>- CSR Read and Write</td> <td><code class="language-plaintext highlighter-rouge">csrrw x1, SOME_CSR, x2</code></td> <td>Read <code class="language-plaintext highlighter-rouge">SOME_CSR</code> into register <code class="language-plaintext highlighter-rouge">x1</code> and simultaneously write <code class="language-plaintext highlighter-rouge">x2</code> into <code class="language-plaintext highlighter-rouge">SOME_CSR</code>.</td> </tr> </tbody> </table></div> <p>One of the most important CSRs is <code class="language-plaintext highlighter-rouge">mepc</code> (CSR address <code class="language-plaintext highlighter-rouge">0x341</code>). When an exception occurs, the <strong>current PC</strong> of the faulting instruction will be written into <code class="language-plaintext highlighter-rouge">mepc</code>. <code class="language-plaintext highlighter-rouge">mepc</code> can be read by system software using the <code class="language-plaintext highlighter-rouge">csrr</code> instruction.</p> <blockquote class="note-title"> <p><code class="language-plaintext highlighter-rouge">mepc</code> will contain whatever the PC was at the exception, regardless of what mode the CPU was previously in.</p> </blockquote> <h3 class="no_toc" id="exception-conditions"> <a href="#exception-conditions" class="anchor-heading" aria-labelledby="exception-conditions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exception Conditions </h3> <p>Whenever a RISC-V CPU encounters an exception condition (perhaps dividing by zero, a usermode program attempts to perform an illegal access, or an undefined instruction is executed), the CPU will execute a privilege transition into machine mode.</p> <p>Recall in lecture when Mengjia introduced the <code class="language-plaintext highlighter-rouge">SYSRET</code> bug on x86_64 machines:</p> <p><img src="figures/riscv-3.png" width="80%" style="margin-left:auto;margin-right:auto;" /></p> <p>This is how x86_64 machines perform privilege transitions (specifically, when a system call is requested). On RISC-V, there exists a very similar mechanism for privilege transitions!</p> <p><img src="figures/riscv-5.png" width="50%" style="margin-left:auto;margin-right:auto;" /></p> <p>The <strong>exception handler</strong> is the code in the kernel that is executed on an exception condition. In the fuzzing lab, you will write one!</p> <!-- ### Exception Handlers {: .no_toc} The **exception handler** is the code that runs in machine mode when the CPU takes an exception. The exception handler has multiple jobs: - Respond to the exception condition in an appropriate manner. - Save the CPU state just prior to the exception (`x1-x31` and `pc` saved in `mepc`). - Modify the CPU state as needed. --> <h2 id="hands-on-puzzles"> <a href="#hands-on-puzzles" class="anchor-heading" aria-labelledby="hands-on-puzzles"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hands-on Puzzles </h2> <p>Check out the <a href="https://github.com/CSAIL-Arch-Sec/SHD-RISCVRec">hands-on puzzle repository</a> for 5 introductory RISC-V programming activities. These exercises will get you familiar with writing RISC-V assembly and the calling convention, as these topics will be useful in the fuzzing lab.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
